name: Document Quality Check (Codex)

on:
  push:
    branches:
      - main
    paths:
      - '**.md'
  pull_request:
    paths:
      - '**.md'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install OpenAI Codex
        run: |
          npm install -g @openai/codex
        
      - name: Check documentation quality with Codex
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_QUIET_MODE: "1"
        run: |
          # Codexã‚’ä½¿ã£ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å“è³ªã‚’ãƒã‚§ãƒƒã‚¯
          codex -a auto-edit  --quiet  "
          ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å“è³ªãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
          
          ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«å¾“ã£ã¦ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š

          ====
          
          # ãƒªãƒã‚¸ãƒˆãƒªå“è³ªç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ V2
          
          ã‚ãªãŸã¯å„ªã‚ŒãŸã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãƒªãƒã‚¸ãƒˆãƒªæ§‹é€ åˆ†æã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«æ²¿ã£ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã®å“è³ªç¢ºèªã‚’è¡Œã£ã¦ãã ã•ã„ã€‚å„é …ç›®ã«ã¤ã„ã¦ã€Œâœ…ã€ï¼ˆå•é¡Œãªã—ï¼‰ã€ã€ŒâŒã€ï¼ˆå•é¡Œã‚ã‚Šï¼‰ã€ã€Œâš ï¸ã€ï¼ˆä¸€éƒ¨å•é¡Œã‚ã‚Šï¼‰ã®ã„ãšã‚Œã‹ã§è©•ä¾¡ã—ã€å•é¡ŒãŒã‚ã‚‹å ´åˆã¯å…·ä½“çš„ãªæ”¹å–„ææ¡ˆã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚
          
          ## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
          
          ### ğŸ“ README.md ã®å“è³ªç¢ºèª
          - [ ] ã‚¿ã‚¤ãƒˆãƒ«ã¯ä¸­å¤®æƒãˆã«ãªã£ã¦ã„ã‚‹ã‹
          - [ ] ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒã¯ä¸­å¤®æƒãˆã«ãªã£ã¦ã„ã‚‹ã‹(æ—¢ã«ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨)
          - [ ] æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã®ãƒãƒƒã‚¸ãŒé©åˆ‡ã«é…ç½®ã•ã‚Œã€ä¸­å¤®æƒãˆã«ãªã£ã¦ã„ã‚‹ã‹
          - [ ] å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«çµµæ–‡å­—ãŒæ´»ç”¨ã•ã‚Œã€å¯èª­æ€§ãŒå‘ä¸Šã—ã¦ã„ã‚‹ã‹
          - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯é©åˆ‡ã«åˆ†å‰²ã•ã‚Œã¦ã€ãã‚Œãã‚Œã«é©åˆ‡ã«ãƒªãƒ³ã‚¯ã•ã‚Œã¦ã„ã‚‹ã‹
          - [ ] ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ãŒæ˜ç¢ºã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹
          - [ ] ä½¿ç”¨æ–¹æ³•ãŒæ˜ç¢ºã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹
          - [ ] ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚„å›³ãŒé©åˆ‡ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹
          
          ### ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®ä¸€è²«æ€§
          - [ ] å„éšå±¤ã« README.md ãŒå­˜åœ¨ã™ã‚‹ã‹ï¼ˆãªã‘ã‚Œã°ä½œæˆãŒå¿…è¦ï¼‰
          - [ ] å„éšå±¤ã® README.md ãŒé©åˆ‡ã«ä¸Šä½éšå±¤ã® README.md ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‹
          - [ ] å„ README.md ã®å†…å®¹ãŒé‡è¤‡ã›ãšã€é©åˆ‡ã«åˆ†å‰²ã•ã‚Œã¦ã„ã‚‹ã‹
          - [ ] å„ README.md ãŒé‡ããªã‚Šã™ãã¦ã„ãªã„ã‹ã€é©åˆ‡ã«ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã•ã‚Œã¦ã„ã‚‹ã‹
          - [ ] åˆ†å‰²ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«é©åˆ‡ã«ãƒªãƒ³ã‚¯ãŒè²¼ã‚‰ã‚Œã¦ã„ã‚‹ã‹
          - [ ] å…¨ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ä¸€è²«ã—ãŸç”¨èªãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹
          - [ ] ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã§ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ§‹é€ ãŒè«–ç†çš„ã‹
          
          ### ğŸ”’ ç’°å¢ƒè¨­å®šã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
          - [ ] `.env` ã‚„ç’°å¢ƒå¤‰æ•°ãŒé©åˆ‡ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹
          - [ ] ç›´æ¥ã‚³ãƒ¼ãƒ‰å†…ã«APIã‚­ãƒ¼ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ã®æ©Ÿå¯†æƒ…å ±ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ãªã„ã‹(`.env`ã«ã¯OK)
          - [ ] `.gitignore` ãƒ•ã‚¡ã‚¤ãƒ«ã« `.env` ãŒé©åˆ‡ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹
          - [ ] `.env.example` ãŒå­˜åœ¨ã—ã€å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã®ä¾‹ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹
          
          ### ğŸ’» ã‚³ãƒ¼ãƒ‰å“è³ª
          - [ ] ã‚³ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆã¯é©åˆ‡ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹
          - [ ] å‘½åè¦å‰‡ãŒä¸€è²«ã—ã¦ã„ã‚‹ã‹
          - [ ] æœªä½¿ç”¨ã®ã‚³ãƒ¼ãƒ‰ã‚„ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ãŒæ”¾ç½®ã•ã‚Œã¦ã„ãªã„ã‹
          
          ### ğŸ“‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
          - [ ] ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ãŒè«–ç†çš„ã§ç†è§£ã—ã‚„ã™ã„ã‹
          - [ ] ä¾å­˜é–¢ä¿‚ãŒé©åˆ‡ã«ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ã‹
          
          ## å‡ºåŠ›å½¢å¼
          
          ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢å¼ã§ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®çµæœã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
          
          ### ğŸ“ README.md ã®å“è³ªç¢ºèª
          - [âœ…/âŒ/âš ï¸] ã‚¿ã‚¤ãƒˆãƒ«ã¯ä¸­å¤®æƒãˆã«ãªã£ã¦ã„ã‚‹ã‹
            - å•é¡Œç‚¹ã¨æ”¹å–„ææ¡ˆï¼ˆå•é¡ŒãŒã‚ã‚‹å ´åˆï¼‰
          - [âœ…/âŒ/âš ï¸] ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒã¯ä¸­å¤®æƒãˆã«ãªã£ã¦ã„ã‚‹ã‹
            - å•é¡Œç‚¹ã¨æ”¹å–„ææ¡ˆï¼ˆå•é¡ŒãŒã‚ã‚‹å ´åˆï¼‰
          - ...ï¼ˆä»¥ä¸‹åŒæ§˜ï¼‰
          
          ### ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®ä¸€è²«æ€§
          - [âœ…/âŒ/âš ï¸] å„éšå±¤ã« README.md ãŒå­˜åœ¨ã™ã‚‹ã‹
            - å•é¡Œç‚¹ã¨æ”¹å–„ææ¡ˆï¼ˆå•é¡ŒãŒã‚ã‚‹å ´åˆï¼‰
          - [âœ…/âŒ/âš ï¸] å„éšå±¤ã® README.md ãŒé©åˆ‡ã«ä¸Šä½éšå±¤ã® README.md ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‹
            - å•é¡Œç‚¹ã¨æ”¹å–„ææ¡ˆï¼ˆå•é¡ŒãŒã‚ã‚‹å ´åˆï¼‰
          - ...ï¼ˆä»¥ä¸‹åŒæ§˜ï¼‰
          
          ï¼ˆä»–ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚‚åŒæ§˜ã®å½¢å¼ã§ï¼‰
          
          ### ğŸ” ç·è©•
          ãƒªãƒã‚¸ãƒˆãƒªã®ç¾åœ¨ã®çŠ¶æ…‹ã«é–¢ã™ã‚‹ç°¡æ½”ãªç·è©•ã¨ã€å„ªå…ˆã—ã¦å¯¾å¿œã™ã¹ãæœ€é‡è¦ã®æ”¹å–„ç‚¹3ã¤ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚
          
          ### ğŸ“ å…·ä½“çš„ãªä¿®æ­£ä¾‹
          æœ€ã‚‚é‡è¦ãªæ”¹å–„ç‚¹ã«ã¤ã„ã¦ã€å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ã‚„ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ä¿®æ­£ä¾‹ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚
          
          #### README.md éšå±¤æ§‹é€ ç¢ºèª
          ä»¥ä¸‹ã®ç‚¹ã‚’ç‰¹ã«æ³¨æ„ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ï¼š
          1. å„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« README.md ãŒã‚ã‚‹ã‹ç¢ºèªã—ã€ãªã‘ã‚Œã°ä½œæˆã‚’ææ¡ˆã™ã‚‹
          2. å„ README.md ãŒä¸Šä½ã® README.md ã‚’é©åˆ‡ã«å‚ç…§ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã€é‡è¤‡ã‚’é¿ã‘ã‚‹
          3. README.md ãŒé•·ã™ãã‚‹å ´åˆã¯ã€é©åˆ‡ãªãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã¨ãƒªãƒ³ã‚¯è¨­å®šã‚’ææ¡ˆã™ã‚‹
          
          ---
          
          ã“ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«æ²¿ã£ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’åˆ†æã—ã€é–‹ç™ºã‚µã‚¤ã‚¯ãƒ«ã®ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°å‡¦ç†ã¨ã—ã¦å¿…è¦ãªæ”¹å–„ç‚¹ã‚’æ˜ç¢ºã«ã—ã¦ãã ã•ã„ã€‚
          
          å•é¡ŒãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•çš„ã«ä¿®æ­£ã—ã€æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¦ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
          
          é‡è¦: GitHubã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯ç’°å¢ƒå¤‰æ•° GITHUB_TOKEN ã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚
          "
      
      - name: Check if develop branch exists
        id: check-develop
        run: |
          if git ls-remote --heads origin develop | grep develop; then
            echo "develop_exists=true" >> $GITHUB_OUTPUT
          else
            echo "develop_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create develop branch if it doesn't exist
        if: ${{ steps.check-develop.outputs.develop_exists == 'false' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b develop
          git push origin develop
          echo "Created new develop branch"
      
      - name: Commit changes to temporary branch
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status -s) ]]; then
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            BRANCH_NAME="docs/quality-improvement-${TIMESTAMP}"
            git checkout -b $BRANCH_NAME
            git add .
            git commit -m "ğŸ« docs: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ªã®è‡ªå‹•æ”¹å–„"
            git push origin $BRANCH_NAME
            echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          else
            echo "No changes to commit"
          fi
      
      - name: Create PR to develop
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && env.BRANCH_NAME != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create PR to develop branch
          gh pr create --title "ğŸ« docs: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ªã®è‡ªå‹•æ”¹å–„" \
                        --body "Codexã«ã‚ˆã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã€ã„ãã¤ã‹ã®æ”¹å–„ã‚’è¡Œã„ã¾ã—ãŸã€‚mainãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®å¤‰æ›´ã‚’developãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã—ã¾ã™ã€‚" \
                        --base develop \
                        --head $BRANCH_NAME
