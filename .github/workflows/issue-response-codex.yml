name: Issue Response Bot (Codex with gh)

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  respond-to-issue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install OpenAI Codex
        run: npm install -g @openai/codex@0.1.2504251709
        
      - name: GitHub CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          type -p curl >/dev/null || apt install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y
          
      - name: Post Initial Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å‡¦ç†é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨æŠ˜ã‚ŠãŸãŸã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚³ãƒ¼ãƒ‰è¡¨ç¤º
          gh issue comment ${{ github.event.issue.number }} --body 'ğŸš€ å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...

          <details>
          <summary>Codexã¸ã®æŒ‡ç¤ºå†…å®¹</summary>

          ```
          ä»¥ä¸‹ã®issueã«å¯¾ã™ã‚‹å¯¾å¿œè¨ˆç”»ã‚’ç«‹ã¦ã€ghã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ï¼š
          
          Issueç•ªå·: #${{ github.event.issue.number }}
          ã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.issue.title }}
          å†…å®¹: ${{ github.event.issue.body }}
          
          å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
          1. issueã‚’åˆ†æã—ã¦å¯¾å¿œæ–¹é‡ã‚’æ±ºå®š
          2. ghã‚³ãƒãƒ³ãƒ‰ã§è¨ˆç”»ã‚’issueã«ã‚³ãƒ¡ãƒ³ãƒˆ (ä¾‹: gh issue comment #ç•ªå· --body '"'"'å†…å®¹'"'"')
          3. å¿…è¦ãªã‚³ãƒ¼ãƒ‰ä¿®æ­£ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã‚’å®Ÿæ–½
          ```
          </details>'

      - name: Debug Information
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦çµæœã‚’å–å¾—
          echo "Codexã®è©³ç´°æƒ…å ±ã‚’å–å¾—ä¸­..."
          
          # æƒ…å ±åé›†
          SYSTEM_INFO=$(uname -a)
          OS_INFO=$(cat /etc/os-release 2>/dev/null || lsb_release -a 2>/dev/null)
          NODE_VERSION=$(node -v)
          NPM_VERSION=$(npm -v)
          CODEX_VERSION=$(codex --version 2>/dev/null || echo 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—å¤±æ•—')
          CODEX_PATH=$(which codex 2>/dev/null || echo 'å ´æ‰€ä¸æ˜')
          CODEX_PACKAGE_INFO=$(npm list -g @openai/codex 2>/dev/null || echo 'æƒ…å ±å–å¾—å¤±æ•—')
          NPM_VERSIONS=$(npm view @openai/codex versions --json 2>/dev/null || echo '[]')
          
          # cgroupç¢ºèª
          if [ -f /proc/1/cgroup ]; then
            CGROUP_EXISTS="âœ… å­˜åœ¨ã—ã¾ã™"
            CGROUP_CONTENT=$(head -n 5 /proc/1/cgroup)
          else
            CGROUP_EXISTS="âŒ å­˜åœ¨ã—ã¾ã›ã‚“"
            CGROUP_CONTENT=""
          fi
          
          # codexã‚³ãƒãƒ³ãƒ‰ã®ãƒ˜ãƒ«ãƒ—æƒ…å ±
          CODEX_HELP=$(codex --help 2>&1 | head -n 20)
          
          # çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "ç’°å¢ƒæƒ…å ±ã‚’issueã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã™"
          {
            echo "## ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±"
            echo "<details>"
            echo "<summary>è©³ç´°æƒ…å ±ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹ï¼‰</summary>"
            echo ""
            echo "ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ã€ŒSandbox was mandated, but no sandbox is available!ã€ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼š"
            echo ""
            echo "### ã‚·ã‚¹ãƒ†ãƒ ç’°å¢ƒ"
            echo "\`\`\`"
            echo "$SYSTEM_INFO"
            echo "$OS_INFO"
            echo "\`\`\`"
            echo ""
            echo "### Node.js & npm æƒ…å ±"
            echo "\`\`\`"
            echo "Node.js: $NODE_VERSION"
            echo "npm: $NPM_VERSION"
            echo "\`\`\`"
            echo ""
            echo "### Codexæƒ…å ±"
            echo "\`\`\`"
            echo "Version: $CODEX_VERSION"
            echo "Path: $CODEX_PATH"
            echo "Package info: "
            echo "$CODEX_PACKAGE_INFO"
            echo "\`\`\`"
            echo ""
            echo "### åˆ©ç”¨å¯èƒ½ãªCodexãƒãƒ¼ã‚¸ãƒ§ãƒ³"
            echo "\`\`\`"
            echo "$NPM_VERSIONS" | jq -r 'if type=="array" then .[-5:] else . end' 2>/dev/null || echo "$NPM_VERSIONS"
            echo "\`\`\`"
            echo ""
            echo "### ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹é–¢é€£"
            echo "/proc/1/cgroup ãƒ•ã‚¡ã‚¤ãƒ«: $CGROUP_EXISTS"
            if [ -n "$CGROUP_CONTENT" ]; then
              echo "\`\`\`"
              echo "$CGROUP_CONTENT"
              echo "\`\`\`"
            fi
            echo ""
            echo "### Codexãƒ˜ãƒ«ãƒ—æƒ…å ±"
            echo "\`\`\`"
            echo "$CODEX_HELP"
            echo "\`\`\`"
            echo ""
            echo "### å¯¾å¿œç­–"
            echo "1. \`--approval=auto\` ã¾ãŸã¯ \`--approval=manual\` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è©¦ã™"
            echo "2. æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°: \`npm install -g @openai/codex@latest\`"
            echo "3. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š: \`FORCE_DISABLE_SANDBOX=true codex ...\`"
            echo "</details>"
          } > debug_info.txt
          
          # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’è¡¨ç¤ºï¼ˆãƒ­ã‚°ç”¨ï¼‰
          cat debug_info.txt
          
          # Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
          gh issue comment ${{ github.event.issue.number }} --body-file debug_info.txt
      
          
      - name: Analyze and Plan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Codexã«è¨ˆç”»ã‚’ç«‹ã¦ã•ã›ã€issueã«ã‚³ãƒ¡ãƒ³ãƒˆã•ã›ã‚‹
          codex --full-auto  --quiet  "ä»¥ä¸‹ã®issueã«å¯¾ã™ã‚‹å¯¾å¿œè¨ˆç”»ã‚’ç«‹ã¦ã€ghã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ï¼š
          
          Issueç•ªå·: #${{ github.event.issue.number }}
          ã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.issue.title }}
          å†…å®¹: ${{ github.event.issue.body }}
          
          å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
          1. issueã‚’åˆ†æã—ã¦å¯¾å¿œæ–¹é‡ã‚’æ±ºå®š
          2. ghã‚³ãƒãƒ³ãƒ‰ã§è¨ˆç”»ã‚’issueã«ã‚³ãƒ¡ãƒ³ãƒˆ (ä¾‹: gh issue comment #ç•ªå· --body 'å†…å®¹')
          3. å¿…è¦ãªã‚³ãƒ¼ãƒ‰ä¿®æ­£ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã‚’å®Ÿæ–½
          
          # é‡è¦ï¼šè¤‡é›‘ãªæ–‡å­—åˆ—ã‚’æ‰±ã†éš›ã¯ã€ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œã‚’é¿ã‘ã‚‹ãŸã‚ã«ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
          # ä¾‹ãˆã°ã€gh issue comment ã‚„ gh pr create ã‚³ãƒãƒ³ãƒ‰ã§ã¯ --body ã‚ˆã‚Šã‚‚ --body-file ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
          # 
          # ä»¥ä¸‹ã®ã‚ˆã†ãªæ–¹æ³•ã§å®Ÿè£…ã—ã¦ãã ã•ã„ï¼š
          # 1. æœ¬æ–‡å†…å®¹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™: echo 'å†…å®¹' > comment.txt
          # 2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§: gh issue comment ç•ªå· --body-file comment.txt
          # 
          # ç‰¹ã«æ”¹è¡Œã‚’å«ã‚€è¤‡é›‘ãªæ–‡å­—åˆ—ã‚’æ‰±ã†å ´åˆã¯å¿…ãšã“ã®æ–¹æ³•ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
          # ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§ã®è¤‡é›‘ãªã‚¨ã‚¹ã‚±ãƒ¼ãƒ— ($\' ã‚„ \" ã®çµ„ã¿åˆã‚ã›) ã¯é¿ã‘ã¦ãã ã•ã„ã€‚"
          
      - name: Create PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç”Ÿæˆ (YYYYMMDDHHmmsså½¢å¼)
          TIMESTAMP=$(date '+%Y%m%d%H%M%S')
          BRANCH_NAME="fix-issue-${{ github.event.issue.number }}-$TIMESTAMP"
          
          # ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª
          git status
          
          # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git checkout -b $BRANCH_NAME
          
          # ãƒ–ãƒ©ãƒ³ãƒåˆ‡ã‚Šæ›¿ãˆå¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª
          git status
          
          # CodexãŒä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’å…¨ã¦è¿½åŠ 
          git add .
          
          # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª
          git status
          
          # Codexã«ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã•ã›ã‚‹
          codex --full-auto --quiet $'ä»¥ä¸‹ã®æ‰‹é †ã§ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
      
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          git status
      
          # é©åˆ‡ãªã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          # Issueç•ªå·ã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’å‚ç…§ã—ã€å¤‰æ›´ã®ç¨®é¡ã«å¿œã˜ã¦å†…å®¹ã‚’èª¿æ•´ã—ã¦ãã ã•ã„
          git commit -m "ğŸ”§ fix: #${{ github.event.issue.number }} ${{ github.event.issue.title }}" -m "ğŸ” å•é¡Œ: ${{ github.event.issue.body }}" -m "âœ… å¯¾å¿œ: å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ãƒ»ä¿®æ­£ã—ã¾ã—ãŸ" -m "Issue: #${{ github.event.issue.number }}"
          
          # ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥
          git push origin HEAD:$BRANCH_NAME
          
          # é‡è¦ï¼šPRã‚„Issueã‚³ãƒ¡ãƒ³ãƒˆã®ä½œæˆæ™‚ã¯ã€è¤‡é›‘ãªæ–‡å­—åˆ—å‡¦ç†ã‚’é¿ã‘ã‚‹ãŸã‚ã«ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
          # PRã®æœ¬æ–‡ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™
          echo "## ğŸš€ å¯¾å¿œå†…å®¹
          ${{ github.event.issue.body }}
          
          ### ğŸ” å•é¡Œã¨è§£æ±ºç­–
          Issueã®å†…å®¹ã«åŸºã¥ã„ã¦é©åˆ‡ãªå¯¾å¿œã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚
          
          ### ğŸ“ å¤‰æ›´å†…å®¹
          - å¤‰æ›´ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¨ãã®å†…å®¹ã®èª¬æ˜
          
          ### ğŸ§ª ãƒ†ã‚¹ãƒˆå†…å®¹
          - å‹•ä½œç¢ºèªæ–¹æ³•ã¨çµæœ
          
          Fixes #${{ github.event.issue.number }}" > pr_body.txt
          
          # PRã‚’ä½œæˆ - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§
          gh pr create \
            --title "âœ¨ fix: #${{ github.event.issue.number }} ${{ github.event.issue.title }}" \
            --body-file pr_body.txt \
            --base main \
            --head $BRANCH_NAME
          
          # PRã®URLã‚’å–å¾—
          PR_URL=$(gh pr view --json url -q .url)
          
          # Issueã‚³ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™
          echo "ğŸ‰ PRä½œæˆå®Œäº†ã—ã¾ã—ãŸï¼
          
          ğŸ‘€ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™
          ğŸ”— PR: $PR_URL
          
          ### ğŸ“‹ å¯¾å¿œæ¦‚è¦
          ${{ github.event.issue.title }}ã«å¯¾å¿œã™ã‚‹PRã‚’ä½œæˆã—ã¾ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼" > comment.txt
          
          # Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§
          gh issue comment ${{ github.event.issue.number }} --body-file comment.txt'
