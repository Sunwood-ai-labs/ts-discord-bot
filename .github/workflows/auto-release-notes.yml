name: Auto Release Notes with Codex

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release-notes:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install OpenAI Codex
        run: npm install -g @openai/codex
        
      - name: Generate Diff File
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ç¾åœ¨ã®ã‚¿ã‚°ã¨å‰ã®ã‚¿ã‚°ã‚’å–å¾—
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
          
          # ã‚¿ã‚°é–“ã®å·®åˆ†ã‚’ç”Ÿæˆã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "ã‚¿ã‚°é–“ã®å·®åˆ†ã‚’ç”Ÿæˆä¸­: ${PREVIOUS_TAG}..${CURRENT_TAG}"
            git diff ${PREVIOUS_TAG}..${CURRENT_TAG} > diff.txt
            echo "ã‚³ãƒŸãƒƒãƒˆãƒ­ã‚°ã‚’ç”Ÿæˆä¸­: ${PREVIOUS_TAG}..${CURRENT_TAG}"
            git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"%h - %s%n%b%n" > commits.txt
          else
            echo "åˆå›žãƒªãƒªãƒ¼ã‚¹: ã™ã¹ã¦ã®å¤‰æ›´ã‚’å«ã‚ã¾ã™"
            git diff $(git rev-list --max-parents=0 HEAD)..HEAD > diff.txt
            git log --pretty=format:"%h - %s%n%b%n" > commits.txt
          fi
          
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
          if [ -n "$PREVIOUS_TAG" ]; then
            git diff --name-status ${PREVIOUS_TAG}..${CURRENT_TAG} > changed_files.txt
          else
            git diff --name-status $(git rev-list --max-parents=0 HEAD)..HEAD > changed_files.txt
          fi
      
      - name: Generate Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_QUIET_MODE: "1"
          CODEX_NO_TTY: "1"
        run: |
          # ç¾åœ¨ã®ã‚¿ã‚°ã¨å‰ã®ã‚¿ã‚°ã‚’å–å¾—
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
          
          # Codexã«ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã®ç”Ÿæˆã‚’æŒ‡ç¤º
          codex -a auto-edit --quiet "ä»¥ä¸‹ã®æƒ…å ±ã‚’ä½¿ã£ã¦ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã‚’ä½œæˆã—ã€release_notes.mdãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          
          ç¾åœ¨ã®ã‚¿ã‚°: ${CURRENT_TAG}
          å‰å›žã®ã‚¿ã‚°: ${PREVIOUS_TAG}
          
          å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
          1. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§åˆ†æžã—ã¦ãã ã•ã„:
             - diff.txt: 2ã¤ã®ã‚¿ã‚°é–“ã®ã‚³ãƒ¼ãƒ‰å·®åˆ†
             - commits.txt: ã‚³ãƒŸãƒƒãƒˆãƒ­ã‚°
             - changed_files.txt: å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆ
          
          2. ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æžã—ã¦ã€ä»¥ä¸‹ã‚’å«ã‚€ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã‚’ä½œæˆï¼š
             - æ–°æ©Ÿèƒ½
             - ãƒã‚°ä¿®æ­£
             - ç ´å£Šçš„å¤‰æ›´
             - ãã®ä»–ã®æ”¹å–„
          
          3. ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã‚’release_notes.mdãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          
          ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã¯ä»¥ä¸‹ã®å½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã—ã¦ãã ã•ã„ï¼š
          # Release ${CURRENT_TAG}: [ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã“ã“ã«è¨˜å…¥]
          
          ## ðŸš€ æ–°æ©Ÿèƒ½
          - æ©Ÿèƒ½ã®èª¬æ˜Ž
          
          ## ðŸ› ãƒã‚°ä¿®æ­£
          - ä¿®æ­£å†…å®¹ã®èª¬æ˜Ž
          
          ## âš ï¸ ç ´å£Šçš„å¤‰æ›´
          - å¤‰æ›´å†…å®¹ã®èª¬æ˜Ž
          
          å‰å›žã®ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€åˆå›žãƒªãƒªãƒ¼ã‚¹ã¨ã—ã¦é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
      
          ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
          echo '# Release ${CURRENT_TAG}' > release_notes.md
          echo '' >> release_notes.md
          # ... (ä»–ã®å†…å®¹) ...
          "
          
          # ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã®å†…å®¹ã‚’è¡¨ç¤º
          if [ -f release_notes.md ]; then
            echo "ç”Ÿæˆã•ã‚ŒãŸãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆ:"
            cat release_notes.md
          else
            echo "ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi
      
      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          # release_notes.mdãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
          if [ -f release_notes.md ]; then
            gh release create ${CURRENT_TAG} --title "ðŸš€ Release ${CURRENT_TAG}" --notes-file release_notes.md
          else
            # CodexãŒå¤±æ•—ã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            echo "# Release ${CURRENT_TAG}" > fallback_notes.md
            echo "" >> fallback_notes.md
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
            if [ -n "$PREVIOUS_TAG" ]; then
              echo "## ã‚³ãƒŸãƒƒãƒˆä¸€è¦§" >> fallback_notes.md
              git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s" >> fallback_notes.md
            else
              echo "## åˆå›žãƒªãƒªãƒ¼ã‚¹" >> fallback_notes.md
              echo "ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®åˆå›žãƒªãƒªãƒ¼ã‚¹ã§ã™ã€‚" >> fallback_notes.md
            fi
            gh release create ${CURRENT_TAG} --title "ðŸŒŸ Release ${CURRENT_TAG}" --notes-file fallback_notes.md
          fi
